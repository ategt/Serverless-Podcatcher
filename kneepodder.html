<!DOCTYPE html>
<html>
<head>
    <title>Serverless Podcatcher</title>
    <style type="text/css">
        .feed-image {
            width: 50px;
        }
        .feed-panel {
            display: flex;
            margin: 10px;
        }
        .feed-image-panel {
            display: flex;
        }
        .feed-image {
            width: 71px;
            align-content: center;
            align-self: center;
            padding: 10px;
            display: block;
        }
        .title {
            text-align: center;
            text-decoration: underline;
            font-size: x-large;
        }
        .description {
            padding: 3px;
        }
        .item {
            border: 1px gray solid;
            max-width: 15%;
            padding: 5px;
            display: block;
            margin: 5px;

            min-width: 10em;
            display: inline-grid;
            height: fit-content;
        }
        .item-description {
            height: 9.6em;
            overflow: hidden;
            margin: 5px 0px;
            /*width: 12em;*/
        }
        .item-enclosure {
            text-align-last: center;
            border: 1px lightgray solid;
            background-color: lightgrey;
        }
        .item-title {
            height: 2.3em;
            overflow: hidden;
        }
        .media-panel {
            display: flow-root;
            height: 26em;
            padding: 2px;
            /* background-color: blue; */
            overflow: overlay;
        }
        a {
            display: block;
            color: black;
            border: 1px darkgrey solid;
        }
        .issue-text {
          color: darkred;
          font-family: auto;
          font-weight: bold;
        }
        .issue-url {
          font-style: italic;
        }
        .issue-pane {
          border: 1px grey solid;
          max-width: 45em;
          padding: 2px;
          overflow: hidden;
          margin: 2px;
        }
        .issue-panel {
          width: fit-content;
          text-align: center;
        }
        .issue-message {
          color: dimgrey;
          font-family: auto;
        }
        .issue-refresh {
          color: brown;
          font-family: inherit;
          font-weight: bold;
        }
        .issue-info {
          display: flex;
        }
        .issue-info-item {
          padding: 2px;
        }
        .issue-main {
          display: flex;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="podcastFeedsList.length | podcastErrorsList.length">
            <div v-for="(podcast, index) in podcastFeedsList"
                        v-bind:index="index"
                        v-bind:key="podcast.id">
                        <podcast v-bind:channel="podcast"></podcast>
            </div>
        </div>
        <div class="nothing-yet" v-else>
            <p>Cool loading screen...</p>
        </div>
        <div v-if="podcastErrorsList.length">
            <div v-for="(problem, index) in podcastErrorsList"
                        v-bind:index="index"
                        v-bind:key="problem.id">
                        <problem v-bind:issue="problem"></problem>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="./vue.js"></script>
    <script type="text/javascript" src="./podcatcher.js"></script>
    <script type="text/javascript" src="./parse-xml.min.js"></script>
    <script type="text/javascript" src="./axios.min.js"></script>
    <script type="text/javascript" src="./download.min.js"></script>
    <script type="text/javascript" src="./test-xhr-response.js"></script>
    <script type="text/javascript">
        Vue.component('podcast', {
          props: ['channel'],
          template: '<div class=\"feed-panel\">\
                        <div class=\"feed-image-panel\">\
                            <div class=\"\" v-if=\"channel.image\">\
                                <img class=\"feed-image\" v-bind:src=\"channel.image.url\" ></img>\
                            </div>\
                        </div>\
                        <div>\
                            <div class=\"title\">{{ channel.title }}</div>\
                            <div class=\"description\" v-html=\"channel.description\"></div>\
                            <div class=\"media-panel\">\
                                <podcast-feed-item \
                                                v-for=\"(item, index) in channel.media\"\
                                                v-bind:item=\"item\"\
                                                v-bind:index=\"index\"\
                                                v-bind:key=\"item.guid\"\
                                                 ></podcast-feed-item>\
                            </div>\
                        </div>\
                    </div>'
        })
        Vue.component('podcast-feed-channel', {
          props: ['channel'],
          template: '<div class=\"feed-panel\">\
                        <div class=\"feed-image-panel\">\
                            <img class=\"feed-image\" v-bind:src=\"channel.image.url\" \>\
                        </div>\
                        <div>\
                            <div class=\"title\">{{ channel.title }}</div>\
                            <div class=\"description\" v-html=\"channel.description\"></div>\
                            <div class=\"media-panel\">\
                            </div>\
                        </div>\
                    </div>'
        })
        Vue.component('problem', {
          props: ['issue'],
          template: '<div class=\"issue-pane\" v-on:click=\"refreshFeed\" >\
                      <div class=\"issue-panel\" >\
                        <div class=\"issue-main\">\
                          <span class=\"issue-explain\"><span class=\"issue-text\">Could not load </span><span class=\"issue-url\">{{ issue.url }}</span></span>\
                        </div>\
                        <div class=\"issue-info\">\
                          <div class=\"issue-refresh issue-info-item\">\
                            Click to Retry\
                          </div>\
                          <div class=\"issue-message issue-info-item\">\
                            {{ issue.error.message }} \
                          </div>\
                        </div>\
                      </div>\
                    </div>',
          methods: {
                    refreshFeed: function() {
                        this.$root.feedRefresher(this.issue.url);
                    }
          }

        })
        Vue.component('podcast-feed-item', {
          props: ['item'],
          template: "<div class=\"item\" v-on:click=\"downloadMedia\">\
                        <div class=\"download-button-holder\">\
                            <span class=\"download-symbol download-button\" />\
                        </div>\
                        <div class=\"item-title\">{{ item.title }}</div>\
                        <div class=\"item-description\" v-html=\"item.description\"></div>\
                    <div class=\"item-enclosure\"><a v-bind:href=\"item.media.url\">link</a></div>\
                </div>",
                //{{ channel.media.slice(0, 5).map((item) => itemMap(item)).join("") }} \\
            methods: {
                    downloadMedia: function() {
                        this.$root.itemDownloader(this.item)
                    }
                }
        })
        const myPodcasts = ["https://www.spreaker.com/ihr/show/2372109/episodes/feed-passthrough",
                                "https://feeds.megaphone.fm/buck-sexton-show",
                                "http://escapepod.org/feed/"
            ];

        const vm = new Vue({
          el: '#app',         
          data: {
            podcastFeedsList: new Array(),
            podcastErrorsList: new Array(),
          },
          methods: {
            itemDownloader: function (item) {
                download(`https://cors-anywhere.herokuapp.com/${item.media.url}`)
            },
            feedRefresher: function(cast_url){
                    axios
                      .get(`https://cors-anywhere.herokuapp.com/${cast_url}`)
                      //.get("http://127.0.0.1:5000/send/drinkin.xml")
                      .then(
                        function(response) {
                          const rss_document = parseXml(response.data);
                          let feed = processRSS(rss_document.children[0]);
                          feed[0].id = vm.podcastFeedsList.length + 1;
                          feed[0].media = assignIds(feed[0].media)
                          vm.podcastFeedsList = vm.podcastFeedsList.concat(feed)
                        }).catch(function(error) {
                          const oldErrors = vm.podcastErrorsList.filter((lerror) => lerror.url === cast_url);
                          if (oldErrors.length == 0) {
                            vm.podcastErrorsList = vm.podcastErrorsList.concat({url:cast_url, error:error, id: vm.podcastErrorsList.length + 1});
                          } else {
                            const position = vm.podcastErrorsList.indexOf(oldErrors[0]);
                            const ammendedError = Object.assign({}, oldErrors[0], {error:error});
                            Vue.set(vm.podcastErrorsList, position, ammendedError)
                          }
                        });
                      }
          },
          mounted () {
            myPodcasts.forEach(this.feedRefresher);
          }
        })
    </script>
</body>
</html>
